<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Video Canvas</title>
</head>

<body style="background: blue">

  <video id="image" src="videoChroma.mp4" width="350" height="350" controls></video>
  <!-- <img id="image" style="display: none" src="prueba3.png" width="350" height="350"> -->
  <img id="image2" style="display: none" src="calavera.png">
  <canvas id="cv" width="350" height="350"></canvas>

  <script>

    class chroma {

      constructor(ctxCanvas, chrImage, rgb, gain = 1) {
        this._ctxCanvas = ctxCanvas
        this._chrImage = chrImage
        this._rgb = rgb
        this._gain = gain
      }

      applyEffect(chrVideo) {

        let videoW = chrVideo.width
        let videoH = chrVideo.height

        this._ctxCanvas.drawImage(chrVideo, 0, 0, videoW, videoH)
        let frame = this._ctxCanvas.getImageData(0, 0, videoW, videoH)
        let large = frame.data.length / 4

        let pos = {
          x: [],
          y: []
        }

        let statistics = {
          median: {},
          fashion: {}
        }

        let repetitions = {
          x: {},
          y: {}
        }

        for (let i = 0; i < large; i++) {
          let r = frame.data[i * 4 + 0];
          let g = frame.data[i * 4 + 1];
          let b = frame.data[i * 4 + 2];
          if (r == this._rgb.r && g == this._rgb.g && b == this._rgb.b) { //RGB color
            let pixel = i + 1
            let posY = Math.ceil(pixel / frame.width)
            let posX = parseInt(pixel - (frame.width * (posY - 1)))
            pos.x.push(posX)
            pos.y.push(posY)

            if (repetitions.x[posX])
              repetitions.x[posX]++
            else
              repetitions.x[posX] = 1


            if (repetitions.y[posY])
              repetitions.y[posY]++
            else
              repetitions.y[posY] = 1
          }

        }

        statistics.fashion.x = Math.max(...Object.values(repetitions.y))//invert to operate
        statistics.fashion.y = Math.max(...Object.values(repetitions.x))

        let pair = (pos.x.length % 2) == 0
        let middle = parseInt(pos.x.length / 2)
        let posOrdX = pos.x.sort(function (a, b) { return a - b }) // order min to max

        if (pair) {
          statistics.median.x = parseInt((posOrdX[middle] + posOrdX[middle + 1]) / 2)
          statistics.median.y = parseInt((pos.y[middle] + pos.y[middle + 1]) / 2)
        } else {
          statistics.median.x = parseInt(posOrdX[middle + 1])
          statistics.median.y = parseInt(pos.y[middle + 1])
        }

        let newLongX = parseInt(statistics.fashion.x * this._gain)
        let newPosX = parseInt(statistics.median.x - (newLongX / 2))

        let newLongY = parseInt(statistics.fashion.y * this._gain)
        let newPosY = parseInt(statistics.median.y - (newLongY / 2))

        this._ctxCanvas.drawImage(this._chrImage, newPosX, newPosY, newLongX, newLongY)
      }

    }

    window.onload = function () {

      let image = document.getElementById('image')
      let image2 = document.getElementById('image2')
      let ctx1 = document.getElementById('cv').getContext('2d')
      let rgb = {
        r: 45,
        g: 255,
        b: 0
      }
      let chroma1 = new chroma(ctx1, image2, rgb, 1.5)

      image.addEventListener("play", function () {
        while (!image.paused || !image.ended)
          chroma1.applyEffect(image)
      });

    }






  </script>
</body>

</html>